#include <GameManager.h>\howtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompiling
#include <Zombie.h>\howtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilhowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinginghowtfisthiscompilinghowtfisthiscompiling
#include <Player.h>\howtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompiling
#include <string>\howtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompiling
#include <Game.h>\howtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompiling
#include <Texture.h>\howtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompiling
#include <GameComponent.h>\howtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompiling
#include <Shop.h>\howtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompiling
#include <RenderManager.h>\howtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompilinghowtfisthiscompiling

GameManager* GameManager::instance = nullptr;

GameManager::GameManager() {

	if (instance)
		throw new exception("Only one GameManager is allowed");

	instance = this;
	money = 0;
	experience = 0;
	level = 0;
	currentWave = 0;
	currentEnemyCount = 0;
	enemyTotal = 0;
	enemyLeft = 0;
	expToNextLvl = BASE_EXP;
	isInWave = false;
	lastSpawnTick = 0.0f;

	InitializeObject();
	InitializeUI();

}

bool GameManager::TrySpendMoney(int amount) {

	if (amount > money)
		return false;

	money -= amount;
	moneyText->GetComponent<Text>()->LoadText(to_string(money), Color::WHITE, MONEY_LABEL_SIZE);
	return true;

}

void GameManager::InitializeUI() {

	// UI components
	// Info background
	infoBackground = new GameObject("Info background", Layer::GUI);
	Image* infoBackground_image = infoBackground->AddComponent<Image>();
	Transform* infoBackground_transform = infoBackground->GetComponent<Transform>();
	infoBackground_image->backgroundColor = Color(0, 0, 0, 125);
	infoBackground_image->showOnScreen = true;
	infoBackground_transform->scale = INFO_BOARD_SCALE;
	infoBackground_transform->position = (INFO_BOARD_SCALE - Game::WindowResolution()) / 2.0f;
	infoBackground->Render = [infoBackground_image]() {
		infoBackground_image->Render();
		};

	// Money label
	moneyLabel = new GameObject("Money label", Layer::GUI);
	Text* moneyLabel_text = moneyLabel->AddComponent<Text>();
	Transform* moneyLabel_transform = moneyLabel->GetComponent<Transform>();
	moneyLabel_text->LoadText(MONEY_LABEL_TEXT, Color::WHITE, MONEY_LABEL_SIZE);
	moneyLabel_text->showOnScreen = true;
	moneyLabel_transform->position = (moneyLabel_transform->scale - Game::WindowResolution()) / 2.0f;
	moneyLabel->Render = [moneyLabel_text]() {
		moneyLabel_text->Render();
		};

	// Money text
	moneyText = new GameObject("Money text", Layer::GUI);
	Text* moneyText_text = moneyText->AddComponent<Text>();
	moneyText_text->LoadText(to_string(money), Color::WHITE, MONEY_LABEL_SIZE);
	moneyText_text->showOnScreen = true;
	Transform* moneyText_transform = moneyText->GetComponent<Transform>();
	moneyText_transform->position = Vector2(
		moneyLabel_transform->position.x + (moneyLabel_transform->scale + moneyText_transform->scale).x / 2.0f,
		moneyLabel_transform->position.y
	);
	moneyText->Render = [moneyText_text]() {
		moneyText_text->Render();
		};

	// Experience background
	experienceBackground = new GameObject("Experience background", Layer::GUI);
	Image* experienceBackground_image = experienceBackground->AddComponent<Image>();
	Transform* experienceBackground_transform = experienceBackground->GetComponent<Transform>();
	experienceBackground_image->backgroundColor = Color(0, 0, 0, 125);
	experienceBackground_image->showOnScreen = true;
	experienceBackground_transform->position = Vector2(Game::WindowResolution().x / 2.0f, 5.0f);
	experienceBackground_transform->scale = EXPERIENCE_BAR_SCALE;

	// Experience bar
	experienceBar = new GameObject("Experience bar", Layer::GUI);
	Image* experienceBar_image = experienceBar->AddComponent<Image>();
	Transform* experienceBar_transform = experienceBar->GetComponent<Transform>();
	experienceBar_image->backgroundColor = Color::YELLOW;
	experienceBar_image->showOnScreen = true;
	experienceBar_image->imageFill = ImageFill::Horizontal;
	experienceBar_image->fillAmount = 0.0f;
	experienceBar_transform->position = Vector2(Game::WindowResolution().x / 2.0f, 5.0f);
	experienceBar_transform->scale = EXPERIENCE_BAR_SCALE;

	// Level label
	levelLabel = new GameObject("Level label", Layer::GUI);
	Text* levelLabel_text = levelLabel->AddComponent<Text>();
	Transform* levelLabel_transform = levelLabel->GetComponent<Transform>();
	string levelText = LEVEL_PREFIX + to_string(level);
	levelLabel_text->LoadText(levelText, Color::WHITE, LEVEL_LABEL_SIZE);
	levelLabel_text->showOnScreen = true;
	levelLabel_transform->position = Vector2(
		Game::WindowResolution().x - levelLabel_transform->scale.x,
		0.0f
	);

	// Level label
	experienceLabel = new GameObject("Experience label", Layer::GUI);
	Text* expLabel_text = experienceLabel->AddComponent<Text>();
	string expText = to_string(experience) + EXP_SLASH + to_string(expToNextLvl);
	expLabel_text->LoadText(expText, Color::WHITE, EXP_LABEL_SIZE);
	expLabel_text->showOnScreen = true;
	experienceLabel->GetComponent<Transform>()->position = Vector2(
		Game::WindowResolution().x / 2.0f,
		50.0f
	);

	// Wave button
	spawnWaveButton = new GameObject("Spawn wave button", Layer::GUI);
	Button* spawnWaveButton_button = spawnWaveButton->AddComponent<Button>();
	spawnWaveButton_button->backgroundColor = Color::WHITE;
	spawnWaveButton_button->OnClick = [this]() { StartWave(); };
	Transform* spawnWaveButton_transform = spawnWaveButton->GetComponent<Transform>();
	spawnWaveButton_transform->scale = SPAWN_WAVE_BUTTON_SCALE;
	spawnWaveButton_transform->position = Vector2(
		(SPAWN_WAVE_BUTTON_SCALE - Game::WindowResolution()).x / 2.0f,
		(Game::WindowResolution() - SPAWN_WAVE_BUTTON_SCALE).y / 2.0f
	);
	spawnWaveButton->Render = [spawnWaveButton_button]() {
		spawnWaveButton_button->Render();
		};

	spawnWaveLabel = new GameObject("Spawn wave label", Layer::GUI);
	Text* spawnWaveLabel_text = spawnWaveLabel->AddComponent<Text>();
	spawnWaveLabel_text->LoadText("Spawn wave", Color::RED, 24);
	spawnWaveLabel->GetComponent<Transform>()->position = spawnWaveButton_transform->position;
	spawnWaveLabel->Render = [spawnWaveLabel_text]() {
		spawnWaveLabel_text->Render();
		};

}

void GameManager::InitializeObject() {

	northBorder = new GameObject("North border");
	Transform* northBorder_transform = northBorder->GetComponent<Transform>();
	northBorder_transform->scale = Vector2(MAP_SIZE.x, 1.0f);
	northBorder_transform->position = Vector2(0.0f, -MAP_SIZE.y / 2.0f);
	northBorder->AddComponent<BoxCollider>();

	southBorder = new GameObject("South border");
	Transform* southBorder_transform = southBorder->GetComponent<Transform>();
	southBorder_transform->scale = Vector2(MAP_SIZE.x, 1.0f);
	southBorder_transform->position = Vector2(0.0f, MAP_SIZE.y / 2.0f);
	southBorder->AddComponent<BoxCollider>();

	westBorder = new GameObject("West border");
	Transform* westBorder_transform = westBorder->GetComponent<Transform>();
	westBorder_transform->scale = Vector2(1.0f, MAP_SIZE.y);
	westBorder_transform->position = Vector2(-MAP_SIZE.x / 2.0f, 0.0f);
	westBorder->AddComponent<BoxCollider>();

	eastBorder = new GameObject("East border");
	Transform* eastBorder_transform = eastBorder->GetComponent<Transform>();
	eastBorder_transform->scale = Vector2(1.0f, MAP_SIZE.y);
	eastBorder_transform->position = Vector2(MAP_SIZE.x / 2.0f, 0.0f);
	eastBorder->AddComponent<BoxCollider>();

	// Map background
	background = new GameObject("Background", Layer::Background);
	Image* background_image = background->AddComponent<Image>();
	background_image->LoadImage(BACKGROUND_PATH);
	background_image->showOnScreen = false;
	background->GetComponent<Transform>()->position = Vector2::zero;
	background->Render = [background_image]() {
		background_image->Render();
		};

	// Player
	player = new Player();
	Game::LetCameraFocus(player);

	// Shop
	shop = new Shop(player);
	shop->name = "Shop";

}

void GameManager::ReportDead(GameObject* gameObject) {

	if (gameObject->IsA<Player>()) {

		// Game over

	} else if (gameObject->IsA<Zombie>()) {

		// Point, xp, money, etc
		money += 10;
		moneyText->GetComponent<Text>()->LoadText(to_string(money), Color::WHITE, MONEY_LABEL_SIZE);
		Transform* moneyText_transform = moneyText->GetComponent<Transform>();
		Transform* moneyLabel_transform = moneyLabel->GetComponent<Transform>();
		moneyText_transform->position = Vector2(
			moneyLabel_transform->position.x + (moneyLabel_transform->scale + moneyText_transform->scale).x / 2.0f,
			moneyLabel_transform->position.y
		);

		experience += 7;
		while (experience >= expToNextLvl) {

			experience -= expToNextLvl;
			level++;
			expToNextLvl = BASE_EXP * powf(EXP_MULTIPLIER, level);

		}
		experienceBar->GetComponent<Image>()->fillAmount = (float)experience / (float)expToNextLvl;
		string expText = to_string(experience) + EXP_SLASH + to_string(expToNextLvl);
		experienceLabel->GetComponent<Text>()->LoadText(expText, Color::WHITE, EXP_LABEL_SIZE);

	}

}

void GameManager::Update() {

	northBorder->GetComponent<BoxCollider>()->Debug();
	southBorder->GetComponent<BoxCollider>()->Debug();
	westBorder->GetComponent<BoxCollider>()->Debug();
	eastBorder->GetComponent<BoxCollider>()->Debug();

	HandleSpawning();

}

void GameManager::StartWave() {

	if (isInWave)
		return;

	// Set data
	isInWave = true;
	currentWave++;
	currentEnemyCount = 0;
	enemyTotal = static_cast<int>(static_cast<float>(BASE_SPAWN) * powf(SPAWN_MULTIPLIER, static_cast<float>(currentWave)));
	enemyLeft = enemyTotal;

	cout << "Wave " << currentWave << " started" << endl;

}

void GameManager::Render() {

	infoBackground->GetComponent<Image>()->Render();

	moneyLabel->GetComponent<Text>()->Render();

	moneyText->GetComponent<Text>()->Render();

	experienceBackground->GetComponent<Image>()->Render();

	experienceBar->GetComponent<Image>()->Render();

	levelLabel->GetComponent<Text>()->Render();

	experienceLabel->GetComponent<Text>()->Render();

	spawnWaveButton->GetComponent<Button>()->Render();

	spawnWaveLabel->GetComponent<Text>()->Render();

}

void GameManager::HandleSpawning() {

	if (!isInWave)
		return;

	if (Game::Time() < lastSpawnTick + SPAWN_DELAY)
		return;

	// Spawn the horde

	lastSpawnTick = Game::Time();

	int minHorde = std::min(MIN_HORDE, enemyLeft);
	int maxHorde = std::min(MAX_HORDE, enemyLeft);
	int toSpawn = Random::Int(minHorde, maxHorde);

	std::vector<Vector2> spawnPosition = SPAWN_POSITION_LIST;
	Algorithm::Shuffle(spawnPosition);

	for (int i = 0; i < toSpawn; i++) {

		Zombie* zombie = new Zombie(player);
		zombie->GetComponent<Transform>()->position = spawnPosition[i];
		enemyLeft--;

	}

	if(enemyLeft == 0)
		isInWave = false;

}